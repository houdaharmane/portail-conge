<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Demande de congé avancée</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
     body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            height: 100vh;
            background: #f6f6f6;
        }
        .sidebar {
            width: 240px;
            background-color: #0074C7;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            min-height: 100vh;
            box-shadow: 2px 0 12px #e9953d22;
            padding: 0;
        }
        .sidebar-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 32px 0 18px 0;
        }
        .sidebar-logo {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            background: #fff;
            box-shadow: 0 2px 8px #fff2;
            margin-bottom: 10px;
        }
        .sidebar-menu {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            padding: 13px 30px;
            border-left: 4px solid transparent;
            transition: background 0.18s, border-left-color 0.18s;
        }
        .sidebar-link i {
            font-size: 20px;
            min-width: 20px;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background: #fff2;
            color: #fff;
            border-left: 4px solid #fff;
        }
        .sidebar-footer {
            margin-bottom: 30px;
        }
        .sidebar-footer .sidebar-link {
            color: #fff;
            opacity: 0.85;
            border-left: 4px solid transparent;
        }
        .sidebar-footer .sidebar-link:hover {
            opacity: 1;
            border-left: 4px solid #fff;
            background: #fff2;
        }
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .header {
            height: 60px;
            background-color: #f3f3f3;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 20px;
            border-bottom: 1px solid #ccc;
            box-shadow: 0 2px 8px #e9953d11;
            
        }
        .header a {
            text-decoration: none;
            color:  #0074C7;
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 17px;
        }
        .header a i {
            margin-right: 8px;
            font-size: 24px;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 40px 20px;
            background-color: #f6f6f6;
            overflow-y: auto;
        }
        .form-container {
            background: white;
            padding: 30px 40px 40px 40px;
            border-radius: 16px;
            box-shadow: 0 4px 12px #00000010;
            width: 100%;
            max-width: 900px;
        }
        .form-container h2 {
            text-align: center;
            color: #0074C7;
            font-weight: 700;
            margin-bottom: 30px;
        }

        /* --- CALENDAR STYLE --- */
        .calendar {
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px #00000015;
            max-width: 880px;
            width: 100%;
            margin: 0 auto 20px auto;
              background: var(--card-bg);
               color: var(--text-color); 
                box-shadow: 0 4px 12px var(--card-shadow);
                margin: 0 auto 20px 0;
                align-self: flex-start;
        }
        .month {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .month-name {
            width: 100%;
            font-weight: bold;
            margin-top: 20px;
            color: #0074C7;
            font-size: 18px;
            color: var(--text-color);
        }
        .day {
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s;
            color: var(--text-color);
            color: #222;
        }
        .day:hover:not(.disabled):not(.taken):not(.selected) {
            background-color: #cce0ff;
        }
        /* Couleurs d’exemple */
        .weekend { background: #bbc9f7; color: white; }
        .taken { background: #ffcc66; cursor: not-allowed; }
        .today { border: 2px solid #0074C7; }
        .selected { background: #0074C7; color: white; }
        .disabled { color: #ccc; cursor: not-allowed; }
        .half-day-select {
            margin-top: 20px;
 color: var(--text-color);              background: var(--header-bg);
            padding: 12px;
            border-radius: 10px;
            display: flex;
            justify-content: space-around;
        }
        .half-day-select div {
            text-align: center;
        }
        .half-day-select label {
            cursor: pointer;
            margin-left: 8px;
            font-weight: 600;
            user-select: none;
             color: var(--text-color);
        }
        .summary {
            margin-top: 20px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            color: var(--text-color);
        }
        button {
            margin-top: 30px;
            background-color: #0074C7;
            border: none;
            padding: 12px 40px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            margin-left: auto;
            color: white;
            font-size: 16px;
            transition: background-color 0.25s;
        }
        button:hover {
            background-color: #005fa3;
        }
           :root {
        --bg-color: #f6f6f6;
        --text-color: #000;
        --header-bg: #f3f3f3;
        --card-bg: #fff;
        --card-shadow: #e9953d22;
        --sidebar-bg: #0074C7;
        --link-color: #fff;
        --button-bg: #0074C7;
        --button-hover: #005fa3;
    }

    .dark-theme {
        --bg-color: #1e1e1e;
        --text-color: #f0f0f0;
        --header-bg: #2c2c2c;
        --card-bg: #2a2a2a;
        --card-shadow: #00000044;
        --sidebar-bg: #0074C7;
        --link-color: #fff;
        --button-bg: #005fa3;
        --button-hover: #0074C7;
    }

    body {
        margin: 0;
        font-family: 'Segoe UI', Arial, sans-serif;
        display: flex;
        height: 100vh;
        background: var(--bg-color);
        color: var(--text-color);
    }

    .sidebar {
        width: 240px;
        background-color: var(--sidebar-bg);
        color: var(--link-color);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: stretch;
        min-height: 100vh;
        box-shadow: 2px 0 12px var(--card-shadow);
        padding: 0;
    }

    .sidebar-link,
    .sidebar-footer .sidebar-link {
        color: var(--link-color);
    }

    .header {
        height: 60px;
        background-color: var(--header-bg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        border-bottom: 1px solid #ccc;
        box-shadow: 0 2px 8px var(--card-shadow);
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 40px 20px;
        background-color: var(--bg-color);
        overflow-y: auto;
    }

    .form-container {
        background: var(--card-bg);
        color: var(--text-color);
        padding: 30px 40px 40px 40px;
        border-radius: 16px;
        box-shadow: 0 4px 12px var(--card-shadow);
        width: 100%;
        max-width: 900px;
    }

    button {
        margin-top: 30px;
        background-color: var(--button-bg);
        border: none;
        padding: 12px 40px;
        font-weight: 700;
        border-radius: 8px;
        cursor: pointer;
        display: block;
        margin-left: auto;
        color: white;
        font-size: 16px;
        transition: background-color 0.25s;
    }

    button:hover {
        background-color: var(--button-hover);
    }

    .theme-toggle-btn {
        background: none;
        border: none;
        font-size: 20px;
        color: #0074C7;
        cursor: pointer;
        margin-top: -2px;
        margin-right: -20px;
    }
    .theme-toggle-btn:hover {
    color: #0074C7 !important;
    background: none !important;
    box-shadow: none !important;
}

    .dark-theme .theme-toggle-btn {
        color: #f0f0f0;
    }
    .sidebar-logo {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    object-fit: cover;
    background: #fff; 
    box-shadow: 0 2px 8px #fff2;
    margin-bottom: 10px;
}

/* Mode sombre */
.dark-theme .sidebar-logo {
    background: #2a2a2a; 
    box-shadow: 0 2px 8px #0005;
}
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--text-color);
}

.form-control {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 15px;
    transition: border-color 0.3s, box-shadow 0.3s;
    background-color: var(--card-bg);
    color: var(--text-color);
    box-sizing: border-box;
}

.form-control:focus {
    border-color: #0074C7;
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 116, 199, 0.2);
}
#formulaire-interesse.form-container {
    max-width: 800px; 
    width: 100%;
    margin: 20px auto 0 auto; 
    padding: 20px 25px 30px 25px; 
}
#back-to-calendar {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: #0074C7;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0;
    margin-left: 20px;
}

#back-to-calendar i {
    font-size: 20px;
}
select.form-control {
    border: 1px solid;
    padding: 10px 15px;
    height: 45px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    font-size: 16px;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
}
body.dark-theme .day {
  color: #eee; /* texte clair */
}

/* Pour les jours désactivés ou pris */
.day.disabled, .day.taken {
  color: #999; /* gris clair mais lisible */
}

/* Thème sombre */
body.dark-theme .day {
  color: #eee; /* texte clair sur fond sombre */
}

body.dark-theme .day.disabled, 
body.dark-theme .day.taken {
  color: #f7f2f2;
}
    </style>
</head>
<body>

<div class="sidebar">
    <div>
        <div class="sidebar-header">
            <img src="/img/modepbg.png" alt="Logo MODEP" class="sidebar-logo">
        </div>
        <nav>
            <a th:href="@{/dashboard-directeur}" th:classappend="${activePage == 'dashboard'} ? ' active'" class="sidebar-link"><i class="fa fa-home"></i> Tableau de bord</a>
            <a th:href="@{/demandes-finales}" th:classappend="${activePage == 'validationFinale'} ? ' active'" class="sidebar-link"><i class="fa fa-check-double"></i> Demandes à valider</a>
            <a th:href="@{/directeur/historique}" th:classappend="${activePage == 'historique'} ? ' active'" class="sidebar-link"><i class="fa fa-history"></i> Historique</a>
            <a th:href="@{/directeur/demande-conge}" th:classappend="${activePage == 'demandeConge'} ? ' active'" class="sidebar-link"><i class="fa fa-plane-departure"></i> Demande de congé</a>
        </nav>
    </div>
    <div class="sidebar-footer">
        <a href="/logout" class="sidebar-link"><i class="fa fa-sign-out-alt"></i> Déconnexion</a>
    </div>
</div>

<div class="main-container">
    <div class="header">
        <a th:href="@{/profil-directeur}"><i class="fa fa-user-circle fa-lg"></i> <span th:text="${directeur.role}">Directeur</span></a>
        <button id="theme-toggle" class="theme-toggle-btn" title="Changer de thème"><i class="fa fa-moon"></i></button>
    </div>
     <div class="main-content">
        <!-- FORMULAIRE CALENDRIER -->
        <div class="form-container" id="calendar-form"
             data-matricule="${directeur.matricule}"
             data-nom="${directeur.nomPrenom}"
             data-role="${directeur.role}">
            <h2>Faire une demande</h2>
            <form th:action="@{/directeur/demande-conge}" method="post" id="congeForm">
                <div class="calendar" id="calendar-container"></div>

                <div class="half-day-select">
                    <div>
                        <div>du <span id="startDateDisplay">--/--/----</span></div>
                        <label><input type="radio" name="startHalf" value="matin" checked> Matin</label>
                        <label><input type="radio" name="startHalf" value="apres-midi"> Après-midi</label>
                    </div>
                    <div>
                        <div>au <span id="endDateDisplay">--/--/----</span></div>
                        <label><input type="radio" name="endHalf" value="matin"> Matin</label>
                        <label><input type="radio" name="endHalf" value="apres-midi" checked> Après-midi</label>
                    </div>
                </div>

                <div class="summary"><span id="workdaysCount">0 jours ouvrés</span></div>

                <input type="hidden" id="dateDebut" name="dateDebut">
                <input type="hidden" id="dateFin" name="dateFin">
                <input type="hidden" id="startHalfHidden" name="startHalf">
                <input type="hidden" id="endHalfHidden" name="endHalf">

                <button type="submit">Continuer</button>
            </form>
        </div>

        <!-- FORMULAIRE INTERESSE -->
        <div id="formulaire-interesse" style="display: none;" class="form-container">
            <button id="back-to-calendar" type="button"><i class="fa fa-arrow-left"></i> Retour</button>
            <h2>Informations de l'intéressé(e)</h2>
            <form id="interesseForm" method="post" th:action="@{/directeur/demande-conge}">
                <div class="form-group">
                    <label>Matricule :</label>
                    <input type="text" name="matricule" id="matriculeField" class="form-control" required />
                </div>
                <div class="form-group">
                    <label>Nom et Prénom :</label>
                    <input type="text" name="nomPrenom" id="nomPrenomField" class="form-control" required />
                </div>
                <div class="form-group">
                    <label>Fonction :</label>
                    <input type="text" name="role" id="roleField" class="form-control" required readonly />
                </div>
                <div class="form-group">
                    <label>Département :</label>
                  <select name="departement.id" class="form-control" required>
    <option value="">-- Sélectionnez un département --</option>
    <option th:value="1" th:selected="${directeur.departement.id == 1}">Ressources Humaines</option>
    <option th:value="2" th:selected="${directeur.departement.id == 2}">Informatique</option>
    <option th:value="3" th:selected="${directeur.departement.id == 3}">Ambulatoire</option>
    <option th:value="4" th:selected="${directeur.departement.id == 4}">Comptabilité</option>
    <option th:value="5" th:selected="${directeur.departement.id == 5}">Affiliation</option>
    <option th:value="6" th:selected="${directeur.departement.id == 6}">Directeur</option>
</select>

                </div>
                <div class="form-group">
                    <label>Durée demandée :</label>
                    <input type="text" name="duree" id="dureeDemande" class="form-control" readonly />
                </div>
                <div class="form-group">
                    <label>Du :</label>
                    <input type="text" name="dateDebut" id="dateDuField" class="form-control" readonly />
                </div>
                <div class="form-group">
                    <label>Au :</label>
                    <input type="text" name="dateFin" id="dateAuField" class="form-control" readonly />
                </div>
                <button type="submit">Confirmer</button>
            </form>
        </div>
    </div>
</div>

    

<script>
document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('theme-toggle');
    const body = document.body;
    if(localStorage.getItem('theme') === 'dark') { 
        body.classList.add('dark-theme'); 
        toggleBtn.innerHTML = '<i class="fa fa-sun"></i>'; 
    }
    toggleBtn.addEventListener('click', () => {
        body.classList.toggle('dark-theme');
        toggleBtn.innerHTML = body.classList.contains('dark-theme') ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
        localStorage.setItem('theme', body.classList.contains('dark-theme') ? 'dark' : 'light');
    });

    const now = new Date(), currentYear = now.getFullYear(), currentMonth = now.getMonth();
    const holidays = ["2025-01-01","2025-04-18","2025-05-01","2025-05-08","2025-05-29","2025-07-14","2025-08-15","2025-11-01","2025-11-11","2025-12-25"];
    const takenDays = [];
    let selectedStart = null, selectedEnd = null;

    function formatDate(date){ return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`; }
    function isWeekend(d){ return d===0||d===6; }

    function selectDate(day, month=currentMonth, year=currentYear){
        const clicked = new Date(year, month, day);
        if(!selectedStart || (selectedStart && selectedEnd)) { selectedStart=clicked; selectedEnd=null; }
        else if(clicked >= selectedStart) selectedEnd=clicked;
        else { selectedStart=clicked; selectedEnd=null; }
        updateDisplay(); createCalendar(month);
    }

    function createCalendar(month=currentMonth){
        const container = document.getElementById('calendar-container'); 
        container.innerHTML='';
        const year=currentYear;
        const firstDay=new Date(year,month,1); 
        const firstWeekDay=firstDay.getDay();
        const daysInMonth=new Date(year,month+1,0).getDate();
        const monthDiv=document.createElement('div'); 
        monthDiv.classList.add('month');
        const monthSelect=document.createElement('select'); 
        for(let i=0;i<12;i++){ 
            const opt=document.createElement('option'); 
            opt.value=i; 
            opt.textContent=new Date(year,i).toLocaleString("fr-FR",{month:"long"}); 
            if(i===month) opt.selected=true; 
            monthSelect.appendChild(opt); 
        }
        monthSelect.addEventListener('change',e=>createCalendar(parseInt(e.target.value,10))); 
        monthDiv.appendChild(monthSelect);
        ['D','L','Ma','Me','J','V','S'].forEach(d=>{
            const dh=document.createElement('div'); 
            dh.classList.add('day'); dh.style.fontWeight='bold'; dh.style.color='#444'; dh.textContent=d; 
            monthDiv.appendChild(dh); 
        });
        for(let i=0;i<firstWeekDay;i++){ 
            const empty=document.createElement('div'); 
            empty.classList.add('day','disabled'); 
            monthDiv.appendChild(empty); 
        }
        for(let day=1;day<=daysInMonth;day++){
            const ddiv=document.createElement('div'); 
            ddiv.classList.add('day');
            const dateObj=new Date(year,month,day);
            const today = new Date(); today.setHours(0,0,0,0);
            const dateCompare = new Date(dateObj); dateCompare.setHours(0,0,0,0);
            if(dateCompare < today) ddiv.classList.add('disabled');
            if(isWeekend(dateObj.getDay())) ddiv.classList.add('weekend'); 
            if(takenDays.includes(formatDate(dateObj))) ddiv.classList.add('taken');
            if(dateObj.toDateString()===now.toDateString()) ddiv.classList.add('today');
            ddiv.textContent=day; 
            ddiv.onclick=()=>{ if(!ddiv.classList.contains('disabled') && !ddiv.classList.contains('taken')) selectDate(day,month,year); };
            monthDiv.appendChild(ddiv);
        }
        container.appendChild(monthDiv);
        updateDisplay();
    }

    function countWorkdaysCustom(start, end) {
        if(!start || !end || end < start) return 0;
        let count = 0;
        for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            count++;
        }
        return count;
    }

    function updateDisplay(){
        document.getElementById('startDateDisplay').textContent=selectedStart?selectedStart.toLocaleDateString('fr-FR'):"--/--/----";
        document.getElementById('endDateDisplay').textContent=selectedEnd?selectedEnd.toLocaleDateString('fr-FR'):"--/--/----";
        document.getElementById('dateDebut').value=selectedStart?formatDate(selectedStart):"";
        document.getElementById('dateFin').value=selectedEnd?formatDate(selectedEnd):"";
        const count=(selectedStart && selectedEnd)?countWorkdaysCustom(selectedStart,selectedEnd):0;
        document.getElementById('workdaysCount').textContent=count+(count>1?" jours ouvrés":" jour ouvré");
        document.getElementById('startHalfHidden').value=document.querySelector('input[name="startHalf"]:checked')?.value||"matin";
        document.getElementById('endHalfHidden').value=document.querySelector('input[name="endHalf"]:checked')?.value||"apres-midi";
    }

    createCalendar();

    // Handler unique pour le submit
    document.getElementById('congeForm').onsubmit = function(e) {
        e.preventDefault();
        if(!selectedStart || !selectedEnd || selectedEnd < selectedStart) {
            alert("Veuillez sélectionner une période valide.");
            return false;
        }

        const calendarForm = document.getElementById('calendar-form');
        document.getElementById('matriculeField').value = calendarForm.dataset.matricule;
        document.getElementById('nomPrenomField').value = calendarForm.dataset.nom;
        document.getElementById('roleField').value = calendarForm.dataset.role;

        document.getElementById('dateDuField').value = document.getElementById('dateDebut').value;
        document.getElementById('dateAuField').value = document.getElementById('dateFin').value;
        document.getElementById('dureeDemande').value = document.getElementById('workdaysCount').textContent;

        document.getElementById('calendar-container').style.display = 'none';
        document.querySelector('.half-day-select').style.display = 'none';
        document.querySelector('.summary').style.display = 'none';
        this.querySelector('button[type="submit"]').style.display = 'none';
        document.getElementById('formulaire-interesse').style.display = 'block';
        return false;
    };

    document.getElementById('back-to-calendar').addEventListener('click',()=>{
        document.getElementById('formulaire-interesse').style.display='none';
        document.getElementById('calendar-container').style.display='block';
        document.querySelector('.half-day-select').style.display='flex';
        document.querySelector('.summary').style.display='block';
        document.querySelector('#congeForm button[type="submit"]').style.display='inline-block';
    });
});

</script>

</body>
</html>
