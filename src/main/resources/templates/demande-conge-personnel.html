<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>RH Dashboard - Demande de congé avancée</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            height: 100vh;
            background: #f6f6f6;
        }
        .sidebar {
            width: 240px;
            background-color: #0074C7;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            min-height: 100vh;
            box-shadow: 2px 0 12px #e9953d22;
            padding: 0;
        }
        .sidebar-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 32px 0 18px 0;
        }
        .sidebar-logo {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            background: #fff;
            box-shadow: 0 2px 8px #fff2;
            margin-bottom: 10px;
        }
        .sidebar-menu {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            padding: 13px 30px;
            border-left: 4px solid transparent;
            transition: background 0.18s, border-left-color 0.18s;
        }
        .sidebar-link i {
            font-size: 20px;
            min-width: 20px;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background: #fff2;
            color: #fff;
            border-left: 4px solid #fff;
        }
        .sidebar-footer {
            margin-bottom: 30px;
        }
        .sidebar-footer .sidebar-link {
            color: #fff;
            opacity: 0.85;
            border-left: 4px solid transparent;
        }
        .sidebar-footer .sidebar-link:hover {
            opacity: 1;
            border-left: 4px solid #fff;
            background: #fff2;
        }
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .header {
            height: 60px;
            background-color: #f3f3f3;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 20px;
            border-bottom: 1px solid #ccc;
            box-shadow: 0 2px 8px #e9953d11;
        }
        .header a {
            text-decoration: none;
            color:  #0074C7;
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 17px;
        }
        .header a i {
            margin-right: 8px;
            font-size: 24px;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 40px 20px;
            background-color: #f6f6f6;
            overflow-y: auto;
        }
        .form-container {
            background: white;
            padding: 30px 40px 40px 40px;
            border-radius: 16px;
            box-shadow: 0 4px 12px #00000010;
            width: 100%;
            max-width: 900px;
        }
        .form-container h2 {
            text-align: center;
            color: #0074C7;
            font-weight: 700;
            margin-bottom: 30px;
        }

        /* --- CALENDAR STYLE --- */
        .calendar {
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px #00000015;
            max-width: 880px;
            width: 100%;
            margin: 0 auto 20px auto;
              background: var(--card-bg);
               color: var(--text-color); 
                box-shadow: 0 4px 12px var(--card-shadow);
                margin: 0 auto 20px 0;
                align-self: flex-start;
        }
        .month {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .month-name {
            width: 100%;
            font-weight: bold;
            margin-top: 20px;
            color: #0074C7;
            font-size: 18px;
            color: var(--text-color);
        }
        .day {
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s;
            color: var(--text-color);
        }
        .day:hover:not(.disabled):not(.taken):not(.selected) {
            background-color: #cce0ff;
        }
        /* Couleurs d’exemple */
        .weekend { background: #bbc9f7; color: white; }
        .taken { background: #ffcc66; cursor: not-allowed; }
        .today { border: 2px solid #0074C7; }
        .selected { background: #0074C7; color: white; }
        .disabled { color: #ccc; cursor: not-allowed; }
        .half-day-select {
            margin-top: 20px;
 color: var(--text-color);              background: var(--header-bg);
            padding: 12px;
            border-radius: 10px;
            display: flex;
            justify-content: space-around;
        }
        .half-day-select div {
            text-align: center;
        }
        .half-day-select label {
            cursor: pointer;
            margin-left: 8px;
            font-weight: 600;
            user-select: none;
             color: var(--text-color);
        }
        .summary {
            margin-top: 20px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            color: var(--text-color);
        }
        button {
            margin-top: 30px;
            background-color: #0074C7;
            border: none;
            padding: 12px 40px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            margin-left: auto;
            color: white;
            font-size: 16px;
            transition: background-color 0.25s;
        }
        button:hover {
            background-color: #005fa3;
        }
           :root {
        --bg-color: #f6f6f6;
        --text-color: #000;
        --header-bg: #f3f3f3;
        --card-bg: #fff;
        --card-shadow: #e9953d22;
        --sidebar-bg: #0074C7;
        --link-color: #fff;
        --button-bg: #0074C7;
        --button-hover: #005fa3;
    }

    .dark-theme {
        --bg-color: #1e1e1e;
        --text-color: #f0f0f0;
        --header-bg: #2c2c2c;
        --card-bg: #2a2a2a;
        --card-shadow: #00000044;
        --sidebar-bg: #0074C7;
        --link-color: #fff;
        --button-bg: #005fa3;
        --button-hover: #0074C7;
    }

    body {
        margin: 0;
        font-family: 'Segoe UI', Arial, sans-serif;
        display: flex;
        height: 100vh;
        background: var(--bg-color);
        color: var(--text-color);
    }

    .sidebar {
        width: 240px;
        background-color: var(--sidebar-bg);
        color: var(--link-color);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: stretch;
        min-height: 100vh;
        box-shadow: 2px 0 12px var(--card-shadow);
        padding: 0;
    }

    .sidebar-link,
    .sidebar-footer .sidebar-link {
        color: var(--link-color);
    }

    .header {
        height: 60px;
        background-color: var(--header-bg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        border-bottom: 1px solid #ccc;
        box-shadow: 0 2px 8px var(--card-shadow);
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 40px 20px;
        background-color: var(--bg-color);
        overflow-y: auto;
    }

    .form-container {
        background: var(--card-bg);
        color: var(--text-color);
        padding: 30px 40px 40px 40px;
        border-radius: 16px;
        box-shadow: 0 4px 12px var(--card-shadow);
        width: 100%;
        max-width: 900px;
    }

    button {
        margin-top: 30px;
        background-color: var(--button-bg);
        border: none;
        padding: 12px 40px;
        font-weight: 700;
        border-radius: 8px;
        cursor: pointer;
        display: block;
        margin-left: auto;
        color: white;
        font-size: 16px;
        transition: background-color 0.25s;
    }

    button:hover {
        background-color: var(--button-hover);
    }

    .theme-toggle-btn {
        background: none;
        border: none;
        font-size: 20px;
        color: #0074C7;
        cursor: pointer;
        margin-top: -2px;
        margin-right: -20px;
    }
    .theme-toggle-btn:hover {
    color: #0074C7 !important;
    background: none !important;
    box-shadow: none !important;
}

    .dark-theme .theme-toggle-btn {
        color: #f0f0f0;
    }
    .sidebar-logo {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    object-fit: cover;
    background: #fff; 
    box-shadow: 0 2px 8px #fff2;
    margin-bottom: 10px;
}

/* Mode sombre */
.dark-theme .sidebar-logo {
    background: #2a2a2a; 
    box-shadow: 0 2px 8px #0005;
}
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--text-color);
}

.form-control {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 15px;
    transition: border-color 0.3s, box-shadow 0.3s;
    background-color: var(--card-bg);
    color: var(--text-color);
    box-sizing: border-box;
}

.form-control:focus {
    border-color: #0074C7;
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 116, 199, 0.2);
}
#formulaire-interesse.form-container {
    max-width: 800px; 
    width: 100%;
    margin: 20px auto 0 auto; 
    padding: 20px 25px 30px 25px; 
}
#back-to-calendar {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: #0074C7;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0;
    margin-left: 20px;
}

#back-to-calendar i {
    font-size: 20px;
}
select.form-control {
    border: 1px solid;
    padding: 10px 15px;
    height: 45px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    font-size: 16px;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
}

    </style>
</head>
<body>

<div class="sidebar">
    <div>
        <div class="sidebar-header">
            <img src="/img/modepbg.png" alt="Logo MODEP" class="sidebar-logo">
        </div>
       <nav>
            <a th:href="@{/personnel/dashboard}" th:classappend="${activePage == 'dashboard'} ? ' active'" class="sidebar-link">
                <i class="fa fa-home"></i> <span>Tableau de bord</span>
            </a>
            <a th:href="@{/conges/demande}" th:classappend="${activePage == 'conges'} ? ' active'" class="sidebar-link">
                <i class="fa fa-calendar-plus"></i> <span>Mes demandes</span>
            </a>
            <a th:href="@{/personnel/profil}" th:classappend="${activePage == 'profil'} ? ' active'" class="sidebar-link">
                <i class="fa fa-user"></i> <span>Mon profil</span>
            </a>
         <a th:href="@{/personnel/demande-conge-personnel}" th:classappend="${activePage == 'demandeConge'} ? ' active'" class="sidebar-link">
    <i class="fa fa-plane-departure"></i> <span>Demande de congé</span>
</a>


        </nav>
    </div>
    <div class="sidebar-footer">
        <a href="/login" class="sidebar-link"><i class="fa fa-sign-out-alt"></i> <span>Déconnexion</span></a>
    </div>
</div>

<div class="main-container">
    <div class="header">
         <button id="theme-toggle" class="theme-toggle-btn" title="Changer de thème">
        <i class="fa fa-moon"></i>
    </button>
    </div>
    <div class="main-content">
        <div class="form-container">
            <h2>Faire une demande</h2>
            <form th:action="@{/personnel/demande-conge-personnel}" method="post" id="congeForm">
                <div class="calendar" id="calendar-container">
                </div>

                <div class="half-day-select">
                    <div>
                        <div>du <span id="startDateDisplay">--/--/----</span></div>
                        <label><input type="radio" name="startHalf" value="matin" checked> Matin</label>
                        <label><input type="radio" name="startHalf" value="apres-midi"> Après-midi</label>
                    </div>
                    <div>
                        <div>au <span id="endDateDisplay">--/--/----</span></div>
                        <label><input type="radio" name="endHalf" value="matin"> Matin</label>
                        <label><input type="radio" name="endHalf" value="apres-midi" checked> Après-midi</label>
                    </div>
                </div>

                <div class="summary">
                    <span id="workdaysCount">0 jours ouvrés</span>
                </div>

                <!-- Champs cachés pour envoi -->
                <input type="hidden" id="dateDebut" name="dateDebut">
                <input type="hidden" id="dateFin" name="dateFin">
                <input type="hidden" id="startHalfHidden" name="startHalf">
                <input type="hidden" id="endHalfHidden" name="endHalf">

                <button type="submit">Continuer</button>
            </form>
            <!-- Formulaire à remplir par l'intéressé -->
<div id="formulaire-interesse" style="display: none; margin-top: 30px;" class="form-container">
   <button id="back-to-calendar" type="button">
    <i class="fa fa-arrow-left"></i>
</button>

    <h2>Informations de l'intéressé(e)</h2>
<form id="interesseForm" method="post" th:action="@{/personnel/conges/demande}">
      <div class="form-group">
            <label>Matricule :</label>
<input type="text" name="matricule" class="form-control" required th:value="${matricule}" />
        </div>
        <div class="form-group">
            <label>Nom et Prénom :</label>
<input type="text" name="nomPrenom" class="form-control" required th:value="${nomPrenom}" />
        </div>
        <div class="form-group">
            <label>Fonction :</label>
            <input type="text" name="fonction" class="form-control" placeholder="Fonction" required value="PERSONNEL"/>
        </div>
      <div class="form-group">
    <label>Département :</label>
    <select name="departement" class="form-control" required>
        <option value="">-- Sélectionnez un département --</option>
        <option value="RH">Ressources Humaines</option>
        <option value="Informatique" selected>Informatique</option>
        <option value="Ambulation">Ambulation</option>
        <option value="Comptabilite">Comptabilite</option>
        <option value="Affiliation">Affiliation</option>
    </select>
</div>
        <div class="form-group">
            <label>Durée demandée :</label>
            <input type="text" name="duree" id="dureeDemande" class="form-control" readonly />
        </div>
        <div class="form-group">
            <label>Du :</label>
            <input type="text" name="dateDu" id="dateDuField" class="form-control" readonly />
        </div>
        <div class="form-group">
            <label>Au :</label>
            <input type="text" name="dateAu" id="dateAuField" class="form-control" readonly />
        </div>

        <button type="submit">Soumettre la demande</button>
    </form>
</div>

        </div>
    </div>
</div>

<script>
 // Date actuelle et informations dynamiques
const now = new Date();
const currentYear = now.getFullYear();
const currentMonth = now.getMonth(); // 0=janvier

// Jours fériés (exemple pour 2025 France)
const holidays = [
  "2025-01-01", "2025-04-18", "2025-05-01", "2025-05-08", "2025-05-29",
  "2025-07-14", "2025-08-15", "2025-11-01", "2025-11-11", "2025-12-25"
];

// Jours déjà pris (exemple)
const takenDays = [
  // Ex: "2025-07-07", "2025-07-15", "2025-07-23"
];

let selectedStart = null;
let selectedEnd = null;

function isWeekend(dayIndex) {
  return dayIndex === 0 || dayIndex === 6; // dimanche=0, samedi=6
}

function formatDate(date) {
  const y = date.getFullYear();
  const m = (date.getMonth() + 1).toString().padStart(2,'0');
  const d = date.getDate().toString().padStart(2,'0');
  return `${y}-${m}-${d}`;
}

function createCalendar() {
  const container = document.getElementById('calendar-container');
  container.innerHTML = '';

  const year = currentYear;
  const month = currentMonth;

  const firstDayOfMonth = new Date(year, month, 1);
  const firstWeekDay = firstDayOfMonth.getDay(); // 0=Dimanche

  const daysInMonth = new Date(year, month+1, 0).getDate();

  const monthDiv = document.createElement('div');
  monthDiv.classList.add('month');

  const monthName = new Date(year, month).toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
  const monthNameDiv = document.createElement('div');
  monthNameDiv.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
  monthNameDiv.classList.add('month-name');
  monthDiv.appendChild(monthNameDiv);

  // Jours de la semaine abrégés
  ['D','L','Ma','Me','J','V','S'].forEach(d => {
    const dayHeader = document.createElement('div');
    dayHeader.classList.add('day');
    dayHeader.style.fontWeight = 'bold';
    dayHeader.style.color = '#444';
    dayHeader.style.width = '28px';
    dayHeader.style.height = '18px';
    dayHeader.style.lineHeight = '18px';
    dayHeader.style.marginBottom = '4px';
    dayHeader.style.userSelect = 'none';
    dayHeader.textContent = d;
    monthDiv.appendChild(dayHeader);
  });

  // Cases vides avant le 1er jour
  for(let i=0; i<firstWeekDay; i++){
    const emptyDay = document.createElement('div');
    emptyDay.classList.add('day', 'disabled');
    monthDiv.appendChild(emptyDay);
  }

  // Crée les jours du mois
  for(let day=1; day<=daysInMonth; day++){
    const dayDiv = document.createElement('div');
    dayDiv.classList.add('day');

    const dateObj = new Date(year, month, day);
    const dayOfWeek = dateObj.getDay();

    if(isWeekend(dayOfWeek)) dayDiv.classList.add('weekend');

    const dayStr = formatDate(dateObj);
    if(takenDays.includes(dayStr)) dayDiv.classList.add('taken');

    const today = new Date();
    if(dateObj.toDateString() === today.toDateString()) dayDiv.classList.add('today');

    dayDiv.textContent = day;

    dayDiv.onclick = () => {
      if(dayDiv.classList.contains('disabled') || dayDiv.classList.contains('taken')) return;
      selectDate(day);
    };

    if(selectedStart === day || selectedEnd === day) {
      dayDiv.classList.add('selected');
    }

    monthDiv.appendChild(dayDiv);
  }

  container.appendChild(monthDiv);
}

function selectDate(day) {
  if(selectedStart === null || (selectedStart !== null && selectedEnd !== null)) {
    selectedStart = day;
    selectedEnd = null;
  } else if(day >= selectedStart){
    selectedEnd = day;
  } else {
    selectedStart = day;
    selectedEnd = null;
  }
  updateDisplay();
  createCalendar();
}

/*
  Calcul des jours ouvrés selon règle personnalisée :
  - Semaine du début : week-ends inclus
  - Semaines suivantes : week-ends exclus
  - Jours fériés toujours comptés comme ouvrés
*/
function countWorkdaysCustom(startDay, endDay, year, month) {
  if(startDay === null || endDay === null || endDay < startDay) return 0;

  const startDate = new Date(year, month, startDay);
  const endDate = new Date(year, month, endDay);

  const startWeekDay = startDate.getDay(); // 0=dimanche
  const diffToMonday = (startWeekDay === 0) ? -6 : 1 - startWeekDay;
  const startWeekMonday = new Date(startDate);
  startWeekMonday.setDate(startDate.getDate() + diffToMonday);

  let count = 0;
  for(let d = new Date(startDate); d <= endDate; d.setDate(d.getDate()+1)) {
    const dayOfWeek = d.getDay();
    const dateStr = formatDate(d);

    if(holidays.includes(dateStr)) {
      count++;
      continue;
    }

    if(d >= startWeekMonday && d <= new Date(startWeekMonday.getFullYear(), startWeekMonday.getMonth(), startWeekMonday.getDate()+6)) {
      count++;
    } else {
      if(dayOfWeek !== 0 && dayOfWeek !== 6) {
        count++;
      }
    }
  }

  return count;
}

function updateDisplay() {
  const startDateSpan = document.getElementById('startDateDisplay');
  const endDateSpan = document.getElementById('endDateDisplay');
  const workdaysSpan = document.getElementById('workdaysCount');

  if(selectedStart !== null){
    startDateSpan.textContent = `${selectedStart}/${currentMonth+1}/${currentYear}`;
    document.getElementById('dateDebut').value = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(selectedStart).padStart(2,'0')}`;
  } else {
    startDateSpan.textContent = "--/--/----";
    document.getElementById('dateDebut').value = "";
  }
  if(selectedEnd !== null){
    endDateSpan.textContent = `${selectedEnd}/${currentMonth+1}/${currentYear}`;
    document.getElementById('dateFin').value = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(selectedEnd).padStart(2,'0')}`;
  } else {
    endDateSpan.textContent = "--/--/----";
    document.getElementById('dateFin').value = "";
  }

  let count = 0;
  if(selectedStart !== null && selectedEnd !== null){
    count = countWorkdaysCustom(selectedStart, selectedEnd, currentYear, currentMonth);
  }
  workdaysSpan.textContent = count + " jour" + (count > 1 ? "s" : "") + " ouvré" + (count > 1 ? "s" : "");

  // Synchroniser radios hidden pour envoi
  const startHalfRadio = document.querySelector('input[name="startHalf"]:checked');
  const endHalfRadio = document.querySelector('input[name="endHalf"]:checked');

  if(startHalfRadio) document.getElementById('startHalfHidden').value = startHalfRadio.value;
  if(endHalfRadio) document.getElementById('endHalfHidden').value = endHalfRadio.value;
}

// Initialisation
createCalendar();
updateDisplay();

// Gestion thème sombre/clair
const toggleBtn = document.getElementById('theme-toggle');
const body = document.body;

if (localStorage.getItem('theme') === 'dark') {
    body.classList.add('dark-theme');
    toggleBtn.innerHTML = '<i class="fa fa-sun"></i>';
}

toggleBtn.addEventListener('click', () => {
    body.classList.toggle('dark-theme');
    const isDark = body.classList.contains('dark-theme');
    toggleBtn.innerHTML = isDark ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
});

// Gestion submit du formulaire calendrier pour afficher le formulaire intéressé
document.getElementById('congeForm').onsubmit = function(e) {
    e.preventDefault();

    if(selectedStart === null || selectedEnd === null || selectedEnd < selectedStart) {
        alert("Veuillez sélectionner une période valide.");
        return false;
    }

    // Remplit le formulaire intéressé avec les dates et durée calculées
    document.getElementById('dateDuField').value = document.getElementById('startDateDisplay').textContent;
    document.getElementById('dateAuField').value = document.getElementById('endDateDisplay').textContent;
    document.getElementById('dureeDemande').value = document.getElementById('workdaysCount').textContent;

    // Cache calendrier + sélecteurs + résumé + bouton Continuer
    document.getElementById('calendar-container').style.display = 'none';
    const halfDaySelect = document.querySelector('.half-day-select');
    if(halfDaySelect) halfDaySelect.style.display = 'none';
    const summary = document.querySelector('.summary');
    if(summary) summary.style.display = 'none';
    const submitBtn = document.querySelector('#congeForm button[type="submit"]');
    if(submitBtn) submitBtn.style.display = 'none';

    // Affiche formulaire intéressé
    document.getElementById('formulaire-interesse').style.display = 'block';

    return false;
};

// Bouton retour vers calendrier
document.getElementById('back-to-calendar').addEventListener('click', () => {
    document.getElementById('formulaire-interesse').style.display = 'none';
    document.getElementById('calendar-container').style.display = 'block';
    const halfDaySelect = document.querySelector('.half-day-select');
    if(halfDaySelect) halfDaySelect.style.display = 'flex';
    const summary = document.querySelector('.summary');
    if(summary) summary.style.display = 'block';
    const submitBtn = document.querySelector('#congeForm button[type="submit"]');
    if(submitBtn) submitBtn.style.display = 'inline-block';
});



</script>

</body>
</html>
